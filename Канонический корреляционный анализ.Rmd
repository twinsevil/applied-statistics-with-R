---
title: "Канонический корреляционный анализ"
author: "Литвинцев И.С"
date: '19 декабря 2017 г '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Канонический корреляционный анализ
Исследуются данные о недоношенных младенцах, у которых вовремя не закрылся артериальный проток. Требуется выяснить, существует ли каноническая зависимость между набором независимых переменных  

1-ый набор:

1)	O2.1	Насыщение крови кислородом до
2)	O2.2 	Насыщение крови кислородом после
3)	Diuresis1	Диурез до
4)	Diuresis.2	Диурез после
5)	PA1	Артериальное давление до
6)	PA2	Артериальное давление после
7)	Р.Р.1	Пульсовое давление до
8)	PP2	Пульсовое давление после

2-ой набор:

1) PS1	Пульс до
2) PS2	Пульс после
3) DF1	Пульсовый диапазон до
4) DF2	Пульсовый диапазон после
5) Sat1	Насыщение крови углекислым газом до
6) Sat2	Насыщение крови углекислым газом после
7) RBC1	Эритроциты до
8) RBC2	Эритроциты после

### 1. Подготовка данных
```{r baseMA}
file <- "C:/Users/806263/Desktop/SPbU/Магистратура Матмех (2017-2019)/Применение статистических методов к реальным данным/Данные/baseMA.csv";
df <- read.csv(file, sep = ";", dec = ".")

features1 <- c("O2.1", "O2.2", "Diuresis1", "Diuresis.2", "PA1", "PA2", "Р.Р.1", "PP2")
features2 <- c("PS1", "PS2", "DF1", "DF2", "Sat1", "Sat2", "RBC1", "RBC2")
U1 <- subset(df, select = features1) 
U2 <- subset(df, select = features2) 
U1 <- scale(U1)
U2 <- scale(U2)
df <- cbind(U1, U2)


df <- na.omit(df)
df <- scale(df)
U1 <- df[,features1]
U2 <- df[,features2]
head(df)
summary(df)
```


### 2. Нахождение канонических корреляций
Разбив признаки на два непересекающихся множества,
$$X = (X_1, \ldots , X_r, X_{r+1}, \ldots, X_{r+s})^T$$
$EX_i=0 \qquad \forall i \in 1:(r+s)$, $U_1=(X_1, \ldots , X_r)^T$, $U_2= (X_{r+1}, \ldots, X_{r+s})^T$.

Обозначим через $\Sigma_{11}=E(U_1U_1^T)$, $\Sigma_{22}=E(U_2U_2^T)$ и $\Sigma_{12}=E(U_1U_2^T)=E(U_2U_1^T)=\Sigma_{21}^T$ ковариационные матрицу подвекторов, образующие общую ковариационную матрицу

$$\Sigma = E(XX^T)=\begin{pmatrix}
\Sigma_{11} & \Sigma_{12} \\
\Sigma_{21} & \Sigma_{22}
\end{pmatrix}$$




Канонические случайные величины обозначим через 
$$V_1 = L^TU_1 \qquad V_2 = M^TU_2,$$
где $L=(l_1, ldots, l_r)^T$, $M=(m_1, \ldots, m_s)^T$ -- векторы канонических коэффициентов.

Чтобы найти канонические коэффициенты необходимо решить две обобщенных задачи на собственные числа и вектора:
$$(\Sigma_{21}\Sigma_{11}^{-1}\Sigma_{12} - \rho^2 \Sigma_{22})M=0,$$ 
что эквивалентно 
$$\Sigma_{22}^{-1}\Sigma_{21}\Sigma_{11}^{-1}\Sigma_{12}M=\rho^2 M.$$
И аналогично
$$(\Sigma_{12}\Sigma_{22}^{-1}\Sigma_{21} - \rho^2 \Sigma_{11})L=0,$$
что эквивалентно 
$$\Sigma_{11}^{-1}\Sigma_{12}\Sigma_{22}^{-1}\Sigma_{21}L=\rho^2 L.$$
Найдем оценки ковариационных матриц
```{r}
S <- list()

S$"11" = cov(U1)
S$"22" = cov(U2)
S$"12" = cov(U1, U2)
S$"21" = cov(U2, U1)
```
Найдем собственные числа и собственные вектора матриц $\Sigma_{22}^{-1}\Sigma_{21}\Sigma_{11}^{-1}\Sigma_{12}$ и 
$\Sigma_{11}^{-1}\Sigma_{12}\Sigma_{22}^{-1}\Sigma_{21}$.
```{r}
M <- solve(S$`22`)%*%S$`21`%*%solve(S$`11`)%*%S$`12`
M.eig <- eigen(M); M.eig

L <- solve(S$`11`)%*%S$`12`%*%solve(S$`22`)%*%S$`21`
L.eig <- eigen(L); L.eig
```
### 3. Проверка результатов

С помощью функци cancor() проверим правильно ли были найдены канонические корреляции и вектора канонических коэффициентов.

```{r}
CC <- cancor(U1, U2)
CC$xcoef
CC$ycoef
```
Т.к. собственные вектора могут находиться неоднозначно, проверим коррелируют ли найденные нами вектора канонических коэффициентов с векторами, полученными с помощью функци cancor().
```{r}
diag(cor(CC$xcoef, L.eig$vectors))
diag(cor(CC$ycoef, M.eig$vectors))
```
Наконец, убедимся, что канонические корреляции были найдены верно.
```{r}
CC$cor
sqrt(L.eig$values)
```
### 4. Значимость канонических корреляций 
Бартлетту принадлежит критерий, основанный на распределении логарифма $s$ сомножителей $\prod_{j=1}^s(1-\rho^2_j)$. ля определенности считаем, что $r \le s$, иначе группы просто
меняются местами. Если предположить, что $k$ канонических корреляций не равны нулю, то статистика критерия для проверки того, что остальные равны нулю, такова:
$$-\Big( n-k-1-\frac{r+s+1}{2}+\sum_{j=1}{r}\rho_j^2 \Big) \ln \big( \prod_{j=k+1}^r (1-\rho^2_j) \big) \sim \chi^2\big( (r-k)(s-k) \big)$$
```{r} 
n <- nrow(df)
r <- ncol(U1)
s <- ncol(U2)
m <- min(r,s) #число канонических корреляций
ro.sq <- CC$cor^2
chi <- c(); pvalue <- c()

for(k in 0:(m-1)){
  chi[k+1] <- (-n-k-1-(r+s+1)/2 + sum(ro.sq))*log(prod(1-ro.sq[(k+1):r]))
  pvalue[k+1] <- 1-pchisq(chi[k+1], (r-k)*(s-k))
}


data.frame(pvalue=pvalue)
pvalue[2]
```
При заданном уровне значимости $\alpha=0.05$ имеем, что первые 3 канонических корреляции значимы, а остальные нет.
 
### 5. Интерпретация канонических величин
#### 5.1 Первая каноническая корреляция
Первая каноническая корреляция между каноническими величинами вида:
$$ V_1^{(1)} = L_1^TU_1 = -0.74X_1 -0.16X_2 -0.28X_3 -0.43X_4 -0.05X_5 -0.21X_6 + 0.22X_7 + 0.24X_8$$
$$V_2^{(1)}=M_1^TU_2=0.24Y_1 -0.27Y_2 -0.05Y_3 -0.48Y_4+  0.46Y_5+ 0.50Y_6 + 0.20Y_7-0.37Y_8$$
равна $R_1=0.64 \; (p=0.00000006)$. Она указывает на корреляцию между:

1) O2.1 Насыщение крови кислородом до
4) Diuresis.2 Диурез после

и

4) DF2 Пульсовый диапазон после
5) Sat1 Насыщение крови углекислым газом до
6) Sat2 Насыщение крови углекислым газом после
```{r}
CC$cor[1]
L.eig$vectors[,1]
M.eig$vectors[,1]
```


#### Вторая каноническая корреляция
Вторая каноническая корреляция между каноническими величинами вида:
$$ V_1^{(2)} = L_1^TU_1 = -0.16X_1 +0.004X_2 +0.79X_3 -0.25X_4 -0.36X_5 +0.07X_6 -0.11X_7 + 0.37X_8$$
$$V_2^{(2)}=M_1^TU_2=0.52Y_1 +0.43Y_2 -0.34Y_3 +0.37Y_4 - 0.316Y_5+ 0.20Y_6 +0.30Y_7+0.22Y_8$$
равна $R_1=0.44 \; (p=0.0048)$. Она указывает на корреляцию между:

3) Diuresis1 Диурез до
4) Diuresis.2 Диурез после

и

1) PS1 Пульс до
2) PS2 Пульс после
3) DF1 Пульсовый диапазон до
4) DF2 Пульсовый диапазон после
```{r}
CC$cor[2]
L.eig$vectors[,2]
M.eig$vectors[,2]
```

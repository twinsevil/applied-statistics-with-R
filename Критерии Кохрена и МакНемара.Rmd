---
title: "Непараметрические методы анализа качественных признаков для повторных наблюдений"
author: "Литвинцев И.С"
date: '26 декабря 2017 г '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Подготовка данных

Исследуются данные об алкогольно-абстинентном синдроме. Нас будут интересовать переменная -- головная боль, которая измерена в три момента времени:

1) headache.1, 
2) headache.2, 
3) headache.3 

```{r data}
file <- "C:/Users/806263/Desktop/SPbU/Магистратура Матмех (2017-2019)/Применение статистических методов к реальным данным/Данные/data_big.csv"
df <- read.csv(file, sep=',',  dec = ",")

data <- na.omit(df[, c(10, 40, 70)])
head(data)
```

## 2. Критерий Мак Немара

Имеется таблица сопряженности. 

X1 \\ X2 | - | + | сумма
--- | --- | --- | ---
- | a | b | a + b
+ | c | d | c + d
сумма | a + c | b + d | n

Нас интересует, насколько значимо различие между частотами b и c. Точная статистика критерия Мак Немара (McNemar’s test) вычисляется как 
$$\alpha_* = 2\sum_{i=0}^{\min(b,c)}C^i_{b + c}\frac{1}{2^{b+c}}$$.

При малых $\alpha_*$ (меньше 0.05) гипотеза о равенстве b = c отвергается и различие
между ними нельзя объяснить случайностью.

Перед применением данного метода необходимо составить таблицу сопряженности. В R это можно сделать с помощью стандартной функции table().

```{r table1, include=FALSE}
# убрали 2 уровень в признаках
data[data == 2] <- 1
```

```{r table}
tb <- table(data[, 1], data[, 2]); tb
```

Теперь найдем значение $\alpha_*$:

```{r alpha}
minimum <- min(tb[1,2], tb[2,1])

sum <- 0
for (i in 1:min(tb[1,2], tb[2,1])) {
  C <- choose(tb[1,2] + tb[2,1], i)
  sum <- sum + C
}
alpha <- sum / 2^(tb[1,2]+ tb[2,1]-1)
alpha
```

Видно, что $\alpha_* > 0.05$, а значит нулевая гипотеза о равенстве b и c не отвергается. 

Применим критей Мак Немара к первым двум столбцам наших данных с помощью функции mcnemar.test(): 

```{r mcnemar}
mcnemar.test(data[, 1], data[, 2], correct=T)
```

## 3. Критерий Кохрена

Для категориальных данных, повторяющихся многократно, используется обобщение
критерия Мак Немара в виде критерия Кохрена (Cochren’s Q test). Пусть имеется
$s$ дихотомических признаков у $n$ индивидов. Для определенности закодируем нулем
ответы „нет“ и единицей ответы „да“, количество положительных ответов у i-го индивида
обозначим через $x_{i*}$, а j-ый момент через $x_{*j}$, $N = \sum^s_{j=1}x_{*j} = \sum^n_{i=1}x_{i*}$.

При отсутствии изменений в динамике наблюдений статистика 
$$T = s(s - 1)\frac{\sum^s_{j=1}(x_{*j}-\frac{N}{s})^2}{\sum^n_{i=1}x_{i*}(s - x_{i*})}$$
имеет распределение хи-квадрат с $s - 1$ степенями свободы.

Перед тем как перейти к расчету статистики $T$, необходимо сделать так, чтобы данные в столбцах принимали только 2 значения: 1 - головная боль есть, 0 - головной боли нет.

```{r data1}
data[data == 2] <- 1

head(data)
```

Теперь перейдем к вычислению $N = \sum_{j=1}^sx_{*j}=\sum_{i=1}^nx_{i*}$.

```{r N}
N <- sum(data)
```

Вычислим статистику $T$:

```{r T}
s <- ncol(data)
T_statistic <- s*(s-1)*((sum((apply(data, 2, sum) - N/s)^2)) / (sum(apply(data,1,sum)*(s - apply(data,1,sum))))) 
T_statistic
```

Вычислим p-значение
```{r p-level}
1 - pchisq(T_statistic, s - 1)
```
Получили незначимость в различии групп.

Для того чтобы применить данный метод в R можно воспользоваться функцией cochrans.q() из библиотеки nonpar. 

```{r cochran}

library("nonpar")
cochrans.q(data, alpha = NULL)
```
Результаты совпали.

---
title: "Множественная регрессия"
author: "Литвинцев И.С"
date: '21 декабря 2017 г '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Множественная регрессия

### 1. Подготовка данных

Исследуются данные о недоношенных младенцах, у которых вовремя не закрылся артериальный проток. Требуется построить уравнение регрессии, проверить значимость регрессии и частных коэффициентов, вычислить множественный коэффициент корреляции, построить частные коэффициенты корреляции, провести пошаговую процедуру. 

```{r baseMA}
file <- "C:/Users/806263/Desktop/SPbU/Магистратура Матмех (2017-2019)/Применение статистических методов к реальным данным/Данные/baseMA.csv";
df <- read.csv(file, sep = ";", dec = ".")

features <- c("O2.1", "O2.2", "Diuresis1", "Diuresis.2", "PA1", "PA2", "Р.Р.1", "PP2", "Weight1")

df <- df[ , features]
df <- na.omit(df)
```


Уравнение линейной регрессии представляется в виде 
$$Y = X\beta + \varepsilon,$$ 

где зависимая переменная задается с помощью вектора $Y = (y_1, ..., y_n)^T$, матрица $X$ -- матрица плана, первый столбик которой заполнен единицами. $\varepsilon \sim N(0, \sigma^2I)$

Вектор оценок $b = (b_0, ..., b_p)^T$ является решением системы нормальных уравнений $(X^TX)\beta = X^TY$. Откуда $b = (X^TX)^{-1}X^TY$.

$\huge{\textbf{Заполнение вектора Y и матрицы плана}}$

Получим уравнение множественной линейной регрессии для нашей задачи. Для этого в переменной Y сохраним значение зависимой переменной.

```{r Y}
Y <- df$Weight1
```

А также составим матрицу плана Х, в которой первый столбец - столбец составленный только из единиц, а остальные столбцы - значения независимых переменных.

```{r X}
X <- rep(1, nrow(df))
X <- as.matrix(cbind(X, subset(df, select = features[-9])))
head(X)
```

$\huge{\textbf{Коэффиценты уравнения регрессии}}$

Теперь перейдем к вычислению коэффициентов в уравнении регрессии. Для этого нам нужно воспользоваться формулой $b = (X^TX)^{-1}X^TY$:

```{r b}
b <- solve(t(X) %*% X) %*% (t(X) %*% Y); b
```

$\huge{\textbf{Множественный коэффициент корреляции}}$

Теперь вычислим множественный коэффициент корреляции. Множественный коэффициент корреляции характеризует тесноту связи между зависимой переменной и предиктором. Он изменяется в пределах от 0 до 1 и рассчитывается по формуле $R_{y|x_1...x_n} = \sqrt{1 - \frac{|R|} {R_{11}}}$, где $|R|$ - определитель корреляционной матрицы, а $R_{11}$ - алгебраическое дополнение.

```{r R}
corr_matr <- cor(df)
R <- sqrt(1 - det(corr_matr) / det(corr_matr[2:nrow(corr_matr), 2:ncol(corr_matr)]))
R
```

$\huge{\textbf{Частные коэффиценты корреляции}}$

Найдем частные коэффициенты корреляции. Эти коэффициенты характеризуют тесноту связи между результатом и фактором при устранении влияния другого фактора (или факторов), которые включены в уравнения регрессии. Пример вычисления частного коэффициента корреляции оставшихся 2-х случайных величин, при фиксированных остальных (p - 2): 

$\varrho_{12.34...p} = - \frac{R_{12}} {\sqrt{R_{11}*R_{22}}}$, где $R_{ij}$ - алгебраическое дополнение элемента {i, j} в корреляционной матрице.

В R для вычисления данных коэффициентов можно воспользоваться функцией -cov2cor(), в которую нужно передать обратную матрицу к матрицу корреляции. Также для вычисления частных коэффициентов корреляции можно воспользоваться функцией pcor() из библиотеки ppcor.

```{r partial.correlation}
partial.correlation <- -cov2cor(solve(cor(df)))
partial.correlation
```

$\huge{\textbf{Значимость коэффициентов регрессии}}$

Теперь необходимо проверить значимость частных коэффициентов регресии. Для этого используется статистика вида $\frac {\varrho_{01.23...p}} {\sqrt{1 - \varrho_{01.23...p}^2}} * \sqrt{n - p - 1}$ ~ $T(n - p - 1)$. 

```{r p.value1}
n <- nrow(df)
p <- nrow(corr_matr) - 1
test.statistic <- partial.correlation * sqrt((n - p - 1) / (1 - partial.correlation ** 2))
p.value1 = 2 * pt(abs(test.statistic), n - p - 1, lower.tail = F)
p.value1[, 1][-1]
```

Можем заметить, что значимо предсказывает длительность госпитализации только нейтрофилы после терапии, причем, как видно из найденных вектора коэффициентов, предсказывает в обратную сторону, т.е. чем она выше, тем ниже длительность госпитализации.

$\huge{\textbf{Значимость регрессии}}$

Теперь необходимо проверить значимость регрессии. Для этого используется статистика вида $\frac{n - p - 1}{p} * \frac{R^2}{1 - R^2}$ ~ $F(p, n - p - 1)$.

```{r p.value}
p.value <- 1 - pf((n - p - 1) / p * (R^2 / (1 - R^2)) , p, n - p - 1)
p.value
```

$\huge{\textbf{Множественная линейная регрессия в R}}$

Замечание: все эти результаты можно было бы получить в R, воспользовавшись функцией lm()

```{r lm}
fit <- lm(Weight1 ~ ., data = df)
summary(fit)
```